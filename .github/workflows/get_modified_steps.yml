name: Detect Modified Steps
on:
  pull_request:
    branches: [ main ]
jobs:
  check-modified-folders:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find modified folders
        id: modified_folders
        run: |
          if [ "$(git rev-parse --is-shallow-repository)" = "true" ]; then
            git fetch --prune --unshallow
          fi
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            BASE=HEAD^
          else
            BASE=$(git hash-object -t tree /dev/null)
          fi
          MODIFIED_FOLDERS=$(git diff --name-only $BASE HEAD flows/steps/ | cut -d'/' -f3 | sort | uniq)
          echo "Modified step folders: $MODIFIED_FOLDERS"
          if [ -n "$MODIFIED_FOLDERS" ]; then
            COMMENT="### Modified Steps\n\nThe following steps were modified in this PR:\n"
            while IFS= read -r folder; do
              if [ -n "$folder" ]; then
                COMMENT="${COMMENT}\n- ${folder}"
              fi
            done <<< "$MODIFIED_FOLDERS"
          else
            COMMENT="### Modified Steps\n\nNo steps were modified in this PR."
          fi
          COMMENT="${COMMENT//'%'/'%25'}"
          COMMENT="${COMMENT//$'\n'/'%0A'}"
          COMMENT="${COMMENT//$'\r'/'%0D'}"
          echo "comment=$COMMENT" >> $GITHUB_OUTPUT
          echo "folders=$MODIFIED_FOLDERS" >> $GITHUB_OUTPUT

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          COMMENT="${{ steps.modified_folders.outputs.comment }}"
          gh pr comment $PR_NUMBER --body "$COMMENT"
