name: Get PR Comment and Run Python Script

on:
  push:
    branches:
      - main

jobs:
  get-pr-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get PR number from commit SHA
        id: get-pr
        uses: actions/github-script@v6
        with:
          script: |
            const sha = process.env.GITHUB_SHA; // Get the current commit SHA
            const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
            });

            if (pullRequests.length === 0) {
              throw new Error(`No pull requests associated with commit SHA ${sha}`);
            }

            // Take the first PR in case there are multiple
            const prNumber = pullRequests[0].number;
            core.setOutput('pr-number', prNumber);

      - name: Get latest comment from GitHub Actions bot
        id: get-comment
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = core.getInput('pr-number');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            // Filter comments by github-actions bot
            const botComments = comments.filter(comment => comment.user.login === 'github-actions[bot]');

            if (botComments.length === 0) {
              throw new Error('No comments found from GitHub Actions bot.');
            }

            // Get the most recent comment
            const latestComment = botComments[botComments.length - 1].body;
            core.setOutput('latest-comment', latestComment);

      - name: Run Python script with the comment
        run: |
          echo "LATEST_COMMENT=${{ steps.get-comment.outputs['latest-comment'] }}" >> $GITHUB_ENV
          python3 print_comment.py
        env:
          LATEST_COMMENT: ${{ steps.get-comment.outputs['latest-comment'] }}

      - name: Print comment from Python script
        run: |
          python3 -c "
          import os
          comment = os.getenv('LATEST_COMMENT')
          print(f'The latest comment by github-actions bot: {comment}')
          "
